VERSION 0.6
IMPORT ../base
IMPORT ../bin
IMPORT ../builder
FROM builder+buildenv

RUN $pacman -S mariadb

DO builder+VERSION --target=mariadb --outfile=version.txt
ARG version=$(cat version.txt)

ARG kube=yes # yes | no

all:
  BUILD +container

buildenv:
  COPY --chown=nonroot:nonroot empty /run/mysqld
  COPY --chown=nonroot:nonroot empty /var/lib/mysql

bins:
  COPY --keep-own +strip/rootfs rootfs
  RUN $pacman -Qql mariadb | grep -P '^/usr/bin' > files.txt
  DO builder+ROOTFS --infile=files.txt

rootfs:
  COPY --chown=nonroot:nonroot empty rootfs/run/mysqld
  IF [ $kube = yes ]
    COPY --chown=nonroot:nonroot empty rootfs/var/lib/mysql
  ELSE
    COPY --chown=nonroot:nonroot +datadir/mysql rootfs/var/lib/mysql
  END
  RUN $pacman -Qql mariadb mariadb-libs | grep -P '^/(etc|usr/(share|lib)/mysql).*[^/]$' > files.txt
  RUN echo '/usr/bin/mariadbd' >> files.txt
  DO builder+ROOTFS --infile=files.txt

container:
  IF [ $kube = yes ]
    ARG suffix=/main
    BUILD +datadir-init-container
    FROM base+scratch
    COPY bin+busybox/umount /usr/bin/
    ARG suffix=/main
  ELSE
    FROM base+scratch
  END
  COPY --keep-own +rootfs/rootfs /
  ENTRYPOINT [ "mariadbd" ]
  DO builder+PUSH --name=mariadb$suffix --tag=$version

datadir:
  FROM +buildenv
  RUN sudo mariadb-install-db --user=nonroot --datadir=/var/lib/mysql
  RUN sudo chown -v nonroot:nonroot /run/mysqld /var/lib/mysql
  COPY install.sql install.sql
  ARG exec
  RUN echo $exec >> install.sql
  RUN mariadbd & sleep 2 && mariadb -u nonroot -e "$(cat install.sql)"
  
  SAVE ARTIFACT /var/lib/mysql

datadir-init-container:
  FROM base+overlay-init
  ARG exec
  ARG name=mariadb/datadir-init
  COPY --chown=nonroot:nonroot (+datadir/mysql --exec=$exec) /init-contents
  DO builder+PUSH --name=$name --tag=$version