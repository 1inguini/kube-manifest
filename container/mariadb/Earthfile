VERSION 0.6
IMPORT ../base
IMPORT ../bin
IMPORT ../builder
FROM builder+buildenv

RUN $pacman -S mariadb

DO builder+VERSION --target=mariadb --outfile=version.txt
ARG version=$(cat version.txt)

ARG kube=yes # yes | no

all:
  BUILD +container

buildenv:
  COPY empty /run/mysqld
  COPY empty /var/lib/mysql

bins:
  COPY +strip/rootfs rootfs
  RUN $pacman -Qql mariadb | grep -P '^/usr/bin' > files.txt
  DO builder+ROOTFS --infile=files.txt

rootfs:
  COPY --chown=nonroot:nonroot empty rootfs/run/mysqld
  IF [ $kube = yes ]
    COPY --chown=nonroot:nonroot empty rootfs/var/lib/mysql
    COPY --chown=root:root bin+execline/if bin+execline/loopwhilex bin+busybox/test rootfs/usr/bin/
  ELSE
    COPY --chown=nonroot:nonroot +datadir/data rootfs/var/lib/mysql
  END
  RUN $pacman -Qql mariadb mariadb-libs > files.txt
  RUN echo '/usr/bin/mariadbd' >> files.txt
  DO builder+ROOTFS --infile=files.txt

container:
  IF [ $kube = yes ]
    ARG suffix=/main
    FROM base+scratch
    ENTRYPOINT [ "if", " loopwhilex", " -x", " 0", " test", " -e", " /var/lib/mysql/mysql", "", "mariadbd" ]
  ELSE
    FROM base+scratch
    ENTRYPOINT [ "mariadbd" ]
  END
  COPY +rootfs/rootfs /
  WORKDIR /var/lib/mysql
  DO builder+PUSH --name=mariadb$suffix --tag=$version

datadir:
  FROM +buildenv
  RUN sudo chown -v nonroot:nonroot /run/mysqld
  RUN mariadb-install-db
  COPY install.sql install.sql
  ARG exec
  RUN echo $exec >> install.sql
  RUN mariadbd --datadir=$PWD/data & sleep 2 && sudo mariadb -u root -e "$(cat install.sql)"
  
  SAVE ARTIFACT data

datadir-container:
  FROM base+overlay
  ARG exec
  ARG name=mariadb/datadir
  COPY --chown=nonroot:nonroot (+datadir/data --exec=$exec) /lowerdir
  DO builder+PUSH --name=$name --tag=$version