VERSION 0.6
IMPORT ../builder
FROM builder+base

RUN $pacman -S mariadb

DO builder+VERSION --target=mariadb --outfile=version.txt
ARG version=$(cat version.txt)

rootfs:
  RUN mkdir -p /tmp/rootfs/run/mysqld/
  RUN $pacman -Qql mariadb | grep -E '^/(etc|usr/(bin|(share|lib)/mysql)).*[^/]$' > files.txt
  DO builder+FILELIST --file=files.txt
  DO builder+ROOTFS --infile=files.txt

strip:
  FROM +rootfs
  DO builder+REMOVE_SH --dir=/tmp/rootfs/usr/bin
  RUN find /tmp/rootfs/usr/bin -type f | grep --invert-match '/usr/bin/mariadbd?$' | sudo xargs rm
  SAVE ARTIFACT --keep-own /tmp/rootfs

container:
  FROM ../base+scratch

  COPY --keep-own +strip/rootfs /

  ENTRYPOINT [ "/usr/bin/mariadbd" ]

  SAVE IMAGE --push registry.1inguini.com/library/mariadb:latest
  SAVE IMAGE --push registry.1inguini.com/library/mariadb:$version

var:
  COPY --keep-own +rootfs/rootfs /tmp/rootfs

  RUN sudo mariadb-install-db --user=nonroot \
    --basedir=/tmp/rootfs/usr --datadir=/tmp/rootfs/var/lib/mysql

  COPY install.sql install.sql
  RUN mariadbd --socket /tmp/rootfs/run/mysqld/mysql.sock \
    --basedir=/tmp/rootfs/usr --datadir=/tmp/rootfs/var/lib/mysql & sleep 2 && \
    mariadb -u nonroot --socket /tmp/rootfs/run/mysqld/mysql.sock -e "$(cat install.sql)" && \
    killall mariadbd
  
  SAVE ARTIFACT --keep-own /tmp/rootfs/var

var-container:
  FROM busybox:latest
  COPY --keep-own +var/ /

  ENTRYPOINT ["/bin/cp", "-rn", "/var/lib/mysql"]
  CMD [ "/mnt" ]
  VOLUME /var/lib/mysql
  SAVE IMAGE --push registry.1inguini.com/library/mariadb/var:latest
  SAVE IMAGE --push registry.1inguini.com/library/mariadb/var:$version

all:
  BUILD +container
  BUILD +var-container
