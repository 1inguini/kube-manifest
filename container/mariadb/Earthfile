VERSION 0.6
IMPORT ../base
IMPORT ../builder
FROM builder+buildenv

RUN $pacman -S mariadb

DO builder+VERSION --target=mariadb --outfile=version.txt
ARG version=$(cat version.txt)


all:
  BUILD +container
  BUILD +var-container

bins:
  COPY --keep-own +strip/rootfs rootfs
  RUN $pacman -Qql mariadb | grep -P '^/usr/bin' > files.txt
  DO builder+ROOTFS --infile=files.txt

strip:
  RUN mkdir -p rootfs/run/mysqld/
  RUN $pacman -Qql mariadb mariadb-libs | grep -P '^/(etc|usr/(share|lib)/mysql).*[^/]$' > files.txt
  RUN echo '/usr/bin/mariadbd' >> files.txt
  DO builder+ROOTFS --infile=files.txt

container:
  FROM base+scratch
  COPY --keep-own +strip/rootfs /
  ENTRYPOINT [ "mariadbd" ]
  DO builder+PUSH --name=mariadb --tag=$version

var:
  RUN mkdir -p rootfs/var/lib/mysql
  RUN sudo chown -v nonroot:nonroot /run/mysqld
  RUN sudo mariadb-install-db --user=nonroot --datadir=$HOME/rootfs/var/lib/mysql

  COPY install.sql install.sql
  RUN mariadbd --datadir=$HOME/rootfs/var/lib/mysql & sleep 2 && \
    mariadb -u nonroot -e "$(cat install.sql)" && \
    killall mariadbd
  
  SAVE ARTIFACT --keep-own rootfs/var

var-container:
  FROM base+cp
  COPY --keep-own +var/ /

  CMD [ "/var/lib/mysql", "/mnt" ]
  VOLUME /var/lib/mysql
  DO builder+PUSH --name=mariadb/var --tag=$version
