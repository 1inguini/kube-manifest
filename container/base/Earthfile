VERSION --use-chmod 0.6
IMPORT ../builder
FROM builder+buildenv

ARG date=$(date --utc +%Y%m%d)

all:
  BUILD +scratch
  BUILD +cp

scratch-rootfs:
  FROM gcr.io/distroless/static:nonroot
  DO +SAVE_FULLPATH --path=/tmp
  DO +SAVE_FULLPATH --path=/home/nonroot
  DO +SAVE_FULLPATH --path=/etc/passwd
  DO +SAVE_FULLPATH --path=/etc/group
  DO +SAVE_FULLPATH --path=/etc/nsswitch.conf
  DO +SAVE_FULLPATH --path=/etc/ssl

scratch:
  FROM scratch
  COPY --keep-own +scratch-rootfs/ /
  WORKDIR /home/nonroot
  USER nonroot
  DO builder+PUSH --name=scratch --tag=$date

SAVE_FULLPATH:
  COMMAND
  ARG --required path
  SAVE ARTIFACT --keep-own "$path" "$path"

cp-rootfs:
  RUN sudo mkdir -p rootfs/
  RUN sudo curl -L -o rootfs/cp https://busybox.net/downloads/binaries/1.35.0-x86_64-linux-musl/busybox_CP
  SAVE ARTIFACT --keep-own rootfs

cp:
  FROM scratch
  COPY --keep-own +cp-rootfs/rootfs /
  ENTRYPOINT [ "/cp", "-vrn" ]
  VOLUME /src
  DO builder+PUSH --name=cp --tag=1.35.0

skalibs:
  RUN $pacman -S musl
  ARG version=v2.12.0.1
  GIT CLONE --branch $version https://github.com/skarnet/skalibs.git skalibs
  WORKDIR skalibs
  RUN ./configure --disable-dynamic --prefix=$HOME/rootfs
  RUN make && sudo make install
  WORKDIR ..
  SAVE ARTIFACT --keep-own rootfs

execline:
  RUN $pacman -S musl
  COPY --keep-own +skalibs/rootfs /usr/lib/musl
  ARG version=v2.9.0.1
  GIT CLONE --branch $version https://github.com/skarnet/execline.git execline
  WORKDIR execline
  RUN ./configure --bindir=$HOME/command --enable-static-libc \
    --with-sysdeps=/usr/lib/musl/lib/skalibs/sysdeps --with-include=/usr/lib/musl/include \
    --with-lib=/usr/lib/musl/lib --with-lib=/usr/lib/musl/lib/skalibs
  RUN make && sudo make install
  WORKDIR ..
  SAVE ARTIFACT --keep-own command/*

busybox:
  RUN sudo curl -L -o command/sleep https://busybox.net/downloads/binaries/1.35.0-x86_64-linux-musl/busybox_SLEEP
  RUN sudo chmod -vR 755 command/
  SAVE ARTIFACT --keep-own command/*
