VERSION --use-chmod 0.6
IMPORT ../bin
IMPORT ../builder
FROM builder+buildenv

all:
  BUILD +scratch
  BUILD +cp

scratch-rootfs:
  FROM gcr.io/distroless/static:nonroot
  DO +SAVE_FULLPATH --path=/tmp
  DO +SAVE_FULLPATH --path=/home/nonroot
  DO +SAVE_FULLPATH --path=/etc/passwd
  DO +SAVE_FULLPATH --path=/etc/group
  DO +SAVE_FULLPATH --path=/etc/nsswitch.conf
  DO +SAVE_FULLPATH --path=/etc/ssl

scratch:
  FROM scratch
  COPY --keep-own +scratch-rootfs/ /
  WORKDIR /home/nonroot
  USER nonroot
  LABEL org.opencontainers.image.description="scratch with nonroot user, ssl certs, nssswitch.conf"
  DO builder+PUSH --name=scratch

SAVE_FULLPATH:
  COMMAND
  ARG --required path
  SAVE ARTIFACT --keep-own "$path" "$path"

cp-init:
  FROM +scratch
  COPY bin+busybox/cp /bin/
  COPY empty /contents
  COPY empty /mnt
  ENTRYPOINT [ "cp", "-rn" ]
  CMD [ "/contents", "/mnt" ]

overlay-init: # use with kubernetes bind propagation bidirectional
  FROM +scratch
  COPY bin+busybox/mount bin+busybox/cp bin+execline/foreground /bin/
  COPY empty /initial-contents
  COPY empty /lowerdir
  COPY empty /upperdir
  COPY empty /workdir
  ENTRYPOINT [ "foreground", "cp", "-rn", "/initial-contents", "/lowerdir", "" ]
  CMD [ "mount", "-t", "overlay", "overlay", "-o", "lowerdir=/lowerdir,upperdir=/upperdir,workdir=/workdir", "/upperdir" ]