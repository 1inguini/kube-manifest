VERSION --use-chmod 0.6
IMPORT ../bin
IMPORT ../builder
FROM builder+buildenv

all:
  BUILD +scratch

scratch-rootfs:
  FROM gcr.io/distroless/static:nonroot
  DO +SAVE_FULLPATH --path=/tmp
  DO +SAVE_FULLPATH --path=/home/nonroot
  DO +SAVE_FULLPATH --path=/etc/passwd
  DO +SAVE_FULLPATH --path=/etc/group
  DO +SAVE_FULLPATH --path=/etc/nsswitch.conf
  DO +SAVE_FULLPATH --path=/etc/ssl

root:
  FROM scratch
  COPY --keep-own +scratch-rootfs/ /

scratch:
  FROM +root
  WORKDIR /home/nonroot
  USER nonroot
  LABEL org.opencontainers.image.description="scratch with nonroot user, ssl certs, nssswitch.conf"
  DO builder+PUSH --name=scratch

SAVE_FULLPATH:
  COMMAND
  ARG --required path
  SAVE ARTIFACT --keep-own "$path" "$path"

cp-init:
  FROM +root
  COPY bin+busybox/cp /bin/
  COPY empty /contents
  COPY empty /mnt
  ENTRYPOINT [ "cp", "-rn" ]
  CMD [ "/contents", "/mnt" ]

overlay: # use with kubernetes bind propagation bidirectional
  FROM +root
  COPY bin+busybox/touch bin+busybox/mount bin+busybox/umount bin+execline/foreground bin+s6-portable-utils/s6-pause /bin/
  COPY --chmod=755 emptydir /lowerdir/test
  COPY --chmod=755 emptydir /upperdir
  COPY --chmod=755 emptydir /workdir
  ENTRYPOINT [ "foreground", "mount", "-t", "overlay", "overlay", "-o", "lowerdir=/lowerdir,upperdir=/upperdir,workdir=/workdir", "/upperdir", "" ]
  CMD [ "s6-pause" ]